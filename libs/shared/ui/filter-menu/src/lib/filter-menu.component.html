<div class="flex gap-0.5">
  <button
    [matButton]="!value() ? 'outlined' : ''"
    class="rounded-small text-default h-8 ps-4 pe-2"
    [class.rounded-e-none]="value()"
    [class.bg-secondary-container]="value()"
    [class.text-on-secondary-container]="value()"
    [matMenuTriggerFor]="menu"
    [disabled]="isDisabled()"
  >
    <span class="flex items-center gap-1">
      {{ value()?.name ?? label() }}
      <mat-icon>arrow_drop_down</mat-icon>
    </span>
  </button>
  @if (value()) {
    <button
      matIconButton
      class="bg-secondary-container text-on-secondary-container rounded-e-small relative h-8 w-8 overflow-hidden rounded-none"
      [style.--mat-icon-button-container-shape.px]="0"
      (click)="$event.stopPropagation(); updateValue(null)"
    >
      <mat-icon class="font-light">close_small</mat-icon>
    </button>
  }
</div>

<mat-menu #menu="matMenu" cl>
  <cdk-virtual-scroll-viewport
    itemSize="48"
    minBufferPx="240"
    maxBufferPx="480"
    [style.width.px]="200"
    [style.height.px]="(menu?._allItems?.length || 0) > 5 ? 240 : (menu?._allItems?.length || 0) * 48"
  >
    <button
      mat-menu-item
      [class.bg-primary-container]="value() === item"
      [class.text-on-primary-container]="value() === item"
      *cdkVirtualFor="let item of datasource()"
      (click)="updateValue(item)"
    >
      @if (value() === item) {
        <mat-icon>check</mat-icon>
      } @else {
        <mat-icon></mat-icon>
      }
      <span>{{ item?.name }}</span>
    </button>
  </cdk-virtual-scroll-viewport>
</mat-menu>
